{% extends "base.html" %}

{% block title %}Batch Prediction - Pima Diabetes Prediction{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0">
                    <i class="fas fa-file-upload me-2"></i>
                    Batch Diabetes Prediction
                </h3>
                <p class="mb-0 mt-2">Upload a CSV file with multiple patient records for batch processing</p>
            </div>
            <div class="card-body">
                <!-- File Upload Form -->
                <form action="/batch-predict" method="POST" enctype="multipart/form-data" id="batchForm">
                    <div class="mb-4">
                        <label for="file" class="form-label">
                            <i class="fas fa-cloud-upload-alt me-2"></i>
                            Select CSV File
                        </label>
                        <input type="file" class="form-control form-control-lg" id="file" name="file" 
                               accept=".csv" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Upload a CSV file containing patient data with all required features
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <button type="submit" class="btn btn-info btn-lg me-md-2">
                            <i class="fas fa-upload me-2"></i>
                            Upload and Predict
                        </button>
                        <button type="reset" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-times me-2"></i>
                            Clear
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- CSV Format Information -->
        <div class="card mt-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Required CSV Format
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">Your CSV file must contain the following columns in any order:</p>
                
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Column Name</th>
                                <th>Description</th>
                                <th>Type</th>
                                <th>Range</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>Pregnancies</code></td>
                                <td>Number of times pregnant</td>
                                <td>Integer</td>
                                <td>0-20</td>
                            </tr>
                            <tr>
                                <td><code>Glucose</code></td>
                                <td>Plasma glucose concentration</td>
                                <td>Float</td>
                                <td>0-300 mg/dL</td>
                            </tr>
                            <tr>
                                <td><code>BloodPressure</code></td>
                                <td>Diastolic blood pressure</td>
                                <td>Integer</td>
                                <td>0-200 mm Hg</td>
                            </tr>
                            <tr>
                                <td><code>SkinThickness</code></td>
                                <td>Triceps skin fold thickness</td>
                                <td>Integer</td>
                                <td>0-100 mm</td>
                            </tr>
                            <tr>
                                <td><code>Insulin</code></td>
                                <td>2-Hour serum insulin</td>
                                <td>Integer</td>
                                <td>0-1000 mu U/ml</td>
                            </tr>
                            <tr>
                                <td><code>BMI</code></td>
                                <td>Body mass index</td>
                                <td>Float</td>
                                <td>10-70 kg/mÂ²</td>
                            </tr>
                            <tr>
                                <td><code>DiabetesPedigreeFunction</code></td>
                                <td>Diabetes pedigree function</td>
                                <td>Float</td>
                                <td>0.0-3.0</td>
                            </tr>
                            <tr>
                                <td><code>Age</code></td>
                                <td>Age in years</td>
                                <td>Integer</td>
                                <td>18-120</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sample CSV Download -->
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>
                    Sample CSV Template
                </h5>
            </div>
            <div class="card-body">
                <p>Download a sample CSV file with the correct format and some example data:</p>
                
                <div class="table-responsive mb-3">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Pregnancies</th>
                                <th>Glucose</th>
                                <th>BloodPressure</th>
                                <th>SkinThickness</th>
                                <th>Insulin</th>
                                <th>BMI</th>
                                <th>DiabetesPedigreeFunction</th>
                                <th>Age</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>6</td>
                                <td>148</td>
                                <td>72</td>
                                <td>35</td>
                                <td>0</td>
                                <td>33.6</td>
                                <td>0.627</td>
                                <td>50</td>
                            </tr>
                            <tr>
                                <td>1</td>
                                <td>85</td>
                                <td>66</td>
                                <td>29</td>
                                <td>0</td>
                                <td>26.6</td>
                                <td>0.351</td>
                                <td>31</td>
                            </tr>
                            <tr>
                                <td>8</td>
                                <td>183</td>
                                <td>64</td>
                                <td>0</td>
                                <td>0</td>
                                <td>23.3</td>
                                <td>0.672</td>
                                <td>32</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <button type="button" class="btn btn-success" onclick="downloadSampleCSV()">
                    <i class="fas fa-download me-2"></i>
                    Download Sample CSV
                </button>
            </div>
        </div>

        <!-- API Usage -->
        <div class="card mt-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-code me-2"></i>
                    API Usage Example
                </h5>
            </div>
            <div class="card-body">
                <h6>Using curl:</h6>
                <pre class="bg-light p-3 rounded"><code>curl -X POST \
  http://localhost:5000/batch-predict \
  -H "Content-Type: multipart/form-data" \
  -F "file=@your_data.csv"</code></pre>
                
                <h6 class="mt-3">Using Python requests:</h6>
                <pre class="bg-light p-3 rounded"><code>import requests

url = "http://localhost:5000/batch-predict"
files = {"file": open("your_data.csv", "rb")}
response = requests.post(url, files=files)
print(response.json())</code></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Generate and download sample CSV
function downloadSampleCSV() {
    const csvContent = `Pregnancies,Glucose,BloodPressure,SkinThickness,Insulin,BMI,DiabetesPedigreeFunction,Age
6,148,72,35,0,33.6,0.627,50
1,85,66,29,0,26.6,0.351,31
8,183,64,0,0,23.3,0.672,32
1,89,66,23,94,28.1,0.167,21
0,137,40,35,168,43.1,2.288,33`;

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sample_diabetes_data.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// File validation
document.getElementById('file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert('Please select a CSV file');
            this.value = '';
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
            alert('File size should be less than 10MB');
            this.value = '';
            return;
        }
        
        // Show file info
        const fileInfo = document.getElementById('fileInfo');
        if (fileInfo) {
            fileInfo.innerHTML = `Selected: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
        }
    }
});

// Form submission with loading state
document.getElementById('batchForm').addEventListener('submit', function(e) {
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    submitBtn.disabled = true;
    
    // Re-enable button after 30 seconds in case of timeout
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 30000);
});
</script>
{% endblock %}
